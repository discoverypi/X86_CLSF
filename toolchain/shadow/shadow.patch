diff -ru a/aclocal.m4 b/aclocal.m4
--- a/aclocal.m4	2009-07-24 03:15:54.000000000 +0200
+++ b/aclocal.m4	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# generated automatically by aclocal 1.10.2 -*- Autoconf -*-
+# generated automatically by aclocal 1.10.1 -*- Autoconf -*-
 
 # Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004,
 # 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
@@ -13,7 +13,7 @@
 
 m4_ifndef([AC_AUTOCONF_VERSION],
   [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
-m4_if(m4_defn([AC_AUTOCONF_VERSION]), [2.63],,
+m4_if(AC_AUTOCONF_VERSION, [2.63],,
 [m4_warning([this file was generated for autoconf 2.63.
 You have another version of autoconf.  It may work, but is not guaranteed to.
 If you have problems, you may need to regenerate the build system entirely.
@@ -4122,18 +4122,6 @@
   dynamic_linker='GNU/Linux ld.so'
   ;;
 
-netbsdelf*-gnu)
-  version_type=linux
-  need_lib_prefix=no
-  need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major ${libname}${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  shlibpath_var=LD_LIBRARY_PATH
-  shlibpath_overrides_runpath=no
-  hardcode_into_libs=yes
-  dynamic_linker='NetBSD ld.elf_so'
-  ;;
-
 netbsd*)
   version_type=sunos
   need_lib_prefix=no
@@ -4725,7 +4713,7 @@
   lt_cv_deplibs_check_method=pass_all
   ;;
 
-netbsd* | netbsdelf*-gnu)
+netbsd*)
   if echo __ELF__ | $CC -E - | $GREP __ELF__ > /dev/null; then
     lt_cv_deplibs_check_method='match_pattern /lib[[^/]]+(\.so\.[[0-9]]+\.[[0-9]]+|_pic\.a)$'
   else
@@ -5406,7 +5394,7 @@
 	    ;;
 	esac
 	;;
-      netbsd* | netbsdelf*-gnu)
+      netbsd*)
 	;;
       *qnx* | *nto*)
         # QNX uses GNU C++, but need to define -shared option too, otherwise
@@ -5831,9 +5819,6 @@
   cygwin* | mingw* | cegcc*)
     _LT_TAGVAR(export_symbols_cmds, $1)='$NM $libobjs $convenience | $global_symbol_pipe | $SED -e '\''/^[[BCDGRS]][[ ]]/s/.*[[ ]]\([[^ ]]*\)/\1 DATA/;/^.*[[ ]]__nm__/s/^.*[[ ]]__nm__\([[^ ]]*\)[[ ]][[^ ]]*/\1 DATA/;/^I[[ ]]/d;/^[[AITW]][[ ]]/s/.* //'\'' | sort | uniq > $export_symbols'
   ;;
-  linux* | k*bsd*-gnu)
-    _LT_TAGVAR(link_all_deplibs, $1)=no
-  ;;
   *)
     _LT_TAGVAR(export_symbols_cmds, $1)='$NM $libobjs $convenience | $global_symbol_pipe | $SED '\''s/.* //'\'' | sort | uniq > $export_symbols'
   ;;
@@ -5898,9 +5883,6 @@
   openbsd*)
     with_gnu_ld=no
     ;;
-  linux* | k*bsd*-gnu)
-    _LT_TAGVAR(link_all_deplibs, $1)=no
-    ;;
   esac
 
   _LT_TAGVAR(ld_shlibs, $1)=yes
@@ -6083,7 +6065,7 @@
       fi
       ;;
 
-    netbsd* | netbsdelf*-gnu)
+    netbsd*)
       if echo __ELF__ | $CC -E - | $GREP __ELF__ >/dev/null; then
 	_LT_TAGVAR(archive_cmds, $1)='$LD -Bshareable $libobjs $deplibs $linker_flags -o $lib'
 	wlarc=
@@ -6258,7 +6240,6 @@
 	if test "$aix_use_runtimelinking" = yes; then
 	  shared_flag="$shared_flag "'${wl}-G'
 	fi
-	_LT_TAGVAR(link_all_deplibs, $1)=no
       else
 	# not using gcc
 	if test "$host_cpu" = ia64; then
@@ -6497,7 +6478,7 @@
       _LT_TAGVAR(link_all_deplibs, $1)=yes
       ;;
 
-    netbsd* | netbsdelf*-gnu)
+    netbsd*)
       if echo __ELF__ | $CC -E - | $GREP __ELF__ >/dev/null; then
 	_LT_TAGVAR(archive_cmds, $1)='$LD -Bshareable -o $lib $libobjs $deplibs $linker_flags'  # a.out
       else
@@ -10181,7 +10162,7 @@
 AC_SUBST($1)dnl
 ])
 
-# Copyright (C) 2002, 2003, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# Copyright (C) 2002, 2003, 2005, 2006, 2007  Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -10196,7 +10177,7 @@
 [am__api_version='1.10'
 dnl Some users find AM_AUTOMAKE_VERSION and mistake it for a way to
 dnl require some minimum version.  Point them to the right macro.
-m4_if([$1], [1.10.2], [],
+m4_if([$1], [1.10.1], [],
       [AC_FATAL([Do not call $0, use AM_INIT_AUTOMAKE([$1]).])])dnl
 ])
 
@@ -10210,12 +10191,12 @@
 # AM_SET_CURRENT_AUTOMAKE_VERSION
 # -------------------------------
 # Call AM_AUTOMAKE_VERSION and AM_AUTOMAKE_VERSION so they can be traced.
-# This function is AC_REQUIREd by AM_INIT_AUTOMAKE.
+# This function is AC_REQUIREd by AC_INIT_AUTOMAKE.
 AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
-[AM_AUTOMAKE_VERSION([1.10.2])dnl
+[AM_AUTOMAKE_VERSION([1.10.1])dnl
 m4_ifndef([AC_AUTOCONF_VERSION],
   [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
-_AM_AUTOCONF_VERSION(m4_defn([AC_AUTOCONF_VERSION]))])
+_AM_AUTOCONF_VERSION(AC_AUTOCONF_VERSION)])
 
 # AM_AUX_DIR_EXPAND                                         -*- Autoconf -*-
 
@@ -10465,28 +10446,19 @@
 
 # Generate code to set up dependency tracking.              -*- Autoconf -*-
 
-# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2008
+# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005
 # Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-#serial 4
+#serial 3
 
 # _AM_OUTPUT_DEPENDENCY_COMMANDS
 # ------------------------------
 AC_DEFUN([_AM_OUTPUT_DEPENDENCY_COMMANDS],
-[# Autoconf 2.62 quotes --file arguments for eval, but not when files
-# are listed without --file.  Let's play safe and only enable the eval
-# if we detect the quoting.
-case $CONFIG_FILES in
-*\'*) eval set x "$CONFIG_FILES" ;;
-*)   set x $CONFIG_FILES ;;
-esac
-shift
-for mf
-do
+[for mf in $CONFIG_FILES; do
   # Strip MF so we end up with the name of the file.
   mf=`echo "$mf" | sed -e 's/:.*$//'`
   # Check whether this is an Automake generated Makefile or not.
@@ -10847,13 +10819,13 @@
 
 # Helper functions for option handling.                     -*- Autoconf -*-
 
-# Copyright (C) 2001, 2002, 2003, 2005, 2008  Free Software Foundation, Inc.
+# Copyright (C) 2001, 2002, 2003, 2005  Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 4
+# serial 3
 
 # _AM_MANGLE_OPTION(NAME)
 # -----------------------
@@ -10870,7 +10842,7 @@
 # ----------------------------------
 # OPTIONS is a space-separated list of Automake options.
 AC_DEFUN([_AM_SET_OPTIONS],
-[m4_foreach_w([_AM_Option], [$1], [_AM_SET_OPTION(_AM_Option)])])
+[AC_FOREACH([_AM_Option], [$1], [_AM_SET_OPTION(_AM_Option)])])
 
 # _AM_IF_OPTION(OPTION, IF-SET, [IF-NOT-SET])
 # -------------------------------------------
diff -ru a/configure b/configure
--- a/configure	2009-07-24 03:15:56.000000000 +0200
+++ b/configure	2014-03-24 23:57:28.000000000 +0100
@@ -923,6 +923,7 @@
 localstatedir
 sharedstatedir
 sysconfdir
+sysroot
 datadir
 datarootdir
 libexecdir
@@ -1015,6 +1016,7 @@
 datarootdir='${prefix}/share'
 datadir='${datarootdir}'
 sysconfdir='${prefix}/etc'
+sysroot='/'
 sharedstatedir='${prefix}/com'
 localstatedir='${prefix}/var'
 includedir='${prefix}/include'
@@ -1304,6 +1306,11 @@
   | --syscon=* | --sysco=* | --sysc=* | --sys=* | --sy=*)
     sysconfdir=$ac_optarg ;;
 
+  -sysroot | --sysroot)
+    ac_prev=sysroot ;;
+  -sysroot=* | --sysroot=*)
+    sysroot=$ac_optarg ;;
+
   -target | --target | --targe | --targ | --tar | --ta | --t)
     ac_prev=target_alias ;;
   -target=* | --target=* | --targe=* | --targ=* | --tar=* | --ta=* | --t=*)
@@ -1409,7 +1416,7 @@
 
 # Check all directory arguments for consistency.
 for ac_var in	exec_prefix prefix bindir sbindir libexecdir datarootdir \
-		datadir sysconfdir sharedstatedir localstatedir includedir \
+		datadir sysconfdir sysroot sharedstatedir localstatedir includedir \
 		oldincludedir docdir infodir htmldir dvidir pdfdir psdir \
 		libdir localedir mandir
 do
@@ -1569,6 +1576,7 @@
   --sbindir=DIR           system admin executables [EPREFIX/sbin]
   --libexecdir=DIR        program executables [EPREFIX/libexec]
   --sysconfdir=DIR        read-only single-machine data [PREFIX/etc]
+  --sysroot=DIR           sysroot []
   --sharedstatedir=DIR    modifiable architecture-independent data [PREFIX/com]
   --localstatedir=DIR     modifiable single-machine data [PREFIX/var]
   --libdir=DIR            object code libraries [EPREFIX/lib]
@@ -6786,7 +6794,7 @@
   lt_cv_deplibs_check_method=pass_all
   ;;
 
-netbsd* | netbsdelf*-gnu)
+netbsd*)
   if echo __ELF__ | $CC -E - | $GREP __ELF__ > /dev/null; then
     lt_cv_deplibs_check_method='match_pattern /lib[^/]+(\.so\.[0-9]+\.[0-9]+|_pic\.a)$'
   else
@@ -9444,9 +9452,6 @@
   openbsd*)
     with_gnu_ld=no
     ;;
-  linux* | k*bsd*-gnu)
-    link_all_deplibs=no
-    ;;
   esac
 
   ld_shlibs=yes
@@ -9629,7 +9634,7 @@
       fi
       ;;
 
-    netbsd* | netbsdelf*-gnu)
+    netbsd*)
       if echo __ELF__ | $CC -E - | $GREP __ELF__ >/dev/null; then
 	archive_cmds='$LD -Bshareable $libobjs $deplibs $linker_flags -o $lib'
 	wlarc=
@@ -9804,7 +9809,6 @@
 	if test "$aix_use_runtimelinking" = yes; then
 	  shared_flag="$shared_flag "'${wl}-G'
 	fi
-	link_all_deplibs=no
       else
 	# not using gcc
 	if test "$host_cpu" = ia64; then
@@ -10219,7 +10223,7 @@
       link_all_deplibs=yes
       ;;
 
-    netbsd* | netbsdelf*-gnu)
+    netbsd*)
       if echo __ELF__ | $CC -E - | $GREP __ELF__ >/dev/null; then
 	archive_cmds='$LD -Bshareable -o $lib $libobjs $deplibs $linker_flags'  # a.out
       else
@@ -11196,18 +11200,6 @@
   dynamic_linker='GNU/Linux ld.so'
   ;;
 
-netbsdelf*-gnu)
-  version_type=linux
-  need_lib_prefix=no
-  need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major ${libname}${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  shlibpath_var=LD_LIBRARY_PATH
-  shlibpath_overrides_runpath=no
-  hardcode_into_libs=yes
-  dynamic_linker='NetBSD ld.elf_so'
-  ;;
-
 netbsd*)
   version_type=sunos
   need_lib_prefix=no
@@ -12141,7 +12133,7 @@
   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2
   lt_status=$lt_dlunknown
   cat > conftest.$ac_ext <<_LT_EOF
-#line 12144 "configure"
+#line 12128 "configure"
 #include "confdefs.h"
 
 #if HAVE_DLFCN_H
@@ -12237,7 +12229,7 @@
   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2
   lt_status=$lt_dlunknown
   cat > conftest.$ac_ext <<_LT_EOF
-#line 12240 "configure"
+#line 12224 "configure"
 #include "confdefs.h"
 
 #if HAVE_DLFCN_H
@@ -24905,16 +24897,7 @@
 
 
   case $ac_file$ac_mode in
-    "depfiles":C) test x"$AMDEP_TRUE" != x"" || # Autoconf 2.62 quotes --file arguments for eval, but not when files
-# are listed without --file.  Let's play safe and only enable the eval
-# if we detect the quoting.
-case $CONFIG_FILES in
-*\'*) eval set x "$CONFIG_FILES" ;;
-*)   set x $CONFIG_FILES ;;
-esac
-shift
-for mf
-do
+    "depfiles":C) test x"$AMDEP_TRUE" != x"" || for mf in $CONFIG_FILES; do
   # Strip MF so we end up with the name of the file.
   mf=`echo "$mf" | sed -e 's/:.*$//'`
   # Check whether this is an Automake generated Makefile or not.
diff -ru a/contrib/Makefile.in b/contrib/Makefile.in
--- a/contrib/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/contrib/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -200,8 +200,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
diff -ru a/doc/Makefile.in b/doc/Makefile.in
--- a/doc/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/doc/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -199,8 +199,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
diff -ru a/etc/Makefile.in b/etc/Makefile.in
--- a/etc/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/etc/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -238,8 +238,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -396,7 +396,7 @@
 	unique=`for i in $$list; do \
 	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
 	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
 	      END { if (nonempty) { for (i in files) print i; }; }'`; \
 	mkid -fID $$unique
 tags: TAGS
diff -ru a/etc/pam.d/Makefile.in b/etc/pam.d/Makefile.in
--- a/etc/pam.d/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/etc/pam.d/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -230,8 +230,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
diff -ru a/lib/commonio.c b/lib/commonio.c
--- a/lib/commonio.c	2009-05-10 15:49:05.000000000 +0200
+++ b/lib/commonio.c	2014-03-24 23:57:28.000000000 +0100
@@ -215,16 +215,6 @@
 		return NULL;
 	}
 
-#ifdef HAVE_FCHOWN
-	if (fchown (fileno (fp), sb->st_uid, sb->st_gid) != 0) {
-		goto fail;
-	}
-#else
-	if (chown (name, sb->st_mode) != 0) {
-		goto fail;
-	}
-#endif
-
 #ifdef HAVE_FCHMOD
 	if (fchmod (fileno (fp), sb->st_mode & 0664) != 0) {
 		goto fail;
@@ -408,8 +398,8 @@
 			/* Tell nscd when lock count goes to zero,
 			   if any of the files were changed.  */
 			if (nscd_need_reload) {
-				nscd_flush_cache ("passwd");
-				nscd_flush_cache ("group");
+//				nscd_flush_cache ("passwd");
+//				nscd_flush_cache ("group");
 				nscd_need_reload = false;
 			}
 #ifdef HAVE_LCKPWDF
@@ -872,7 +862,7 @@
 		 * Default permissions for new [g]shadow files.
 		 * (passwd and group always exist...)
 		 */
-		sb.st_mode = 0400;
+		sb.st_mode = 0600;
 		sb.st_uid = 0;
 		sb.st_gid = 0;
 	}
diff -ru a/lib/defines.h b/lib/defines.h
--- a/lib/defines.h	2009-05-19 10:05:10.000000000 +0200
+++ b/lib/defines.h	2014-03-24 23:57:28.000000000 +0100
@@ -299,20 +299,20 @@
 	(strncpy((A), (B), sizeof(A) - 1), (A)[sizeof(A) - 1] = '\0')
 
 #ifndef PASSWD_FILE
-#define PASSWD_FILE "/etc/passwd"
+#define PASSWD_FILE SYSROOT"/etc/passwd"
 #endif
 
 #ifndef GROUP_FILE
-#define GROUP_FILE "/etc/group"
+#define GROUP_FILE SYSROOT"/etc/group"
 #endif
 
 #ifndef SHADOW_FILE
-#define SHADOW_FILE "/etc/shadow"
+#define SHADOW_FILE SYSROOT"/etc/shadow"
 #endif
 
 #ifdef SHADOWGRP
 #ifndef SGROUP_FILE
-#define SGROUP_FILE "/etc/gshadow"
+#define SGROUP_FILE SYSROOT"/etc/gshadow"
 #endif
 #endif
 
diff -ru a/lib/getdef.c b/lib/getdef.c
--- a/lib/getdef.c	2009-04-23 13:46:47.000000000 +0200
+++ b/lib/getdef.c	2014-03-24 23:57:28.000000000 +0100
@@ -128,7 +128,7 @@
 };
 
 #ifndef LOGINDEFS
-#define LOGINDEFS "/etc/login.defs"
+#define LOGINDEFS SYSROOT"/etc/login.defs"
 #endif
 
 static char def_fname[] = LOGINDEFS;	/* login config defs file       */
diff -ru a/lib/gshadow_.h b/lib/gshadow_.h
--- a/lib/gshadow_.h	2009-04-25 02:20:11.000000000 +0200
+++ b/lib/gshadow_.h	2014-03-24 23:57:28.000000000 +0100
@@ -71,5 +71,5 @@
 int putsgent ();
 #endif
 
-#define	GSHADOW	"/etc/gshadow"
+#define	GSHADOW	SYSROOT"/etc/gshadow"
 #endif				/* ifndef _H_GSHADOW */
diff -ru a/lib/Makefile.am b/lib/Makefile.am
--- a/lib/Makefile.am	2009-04-24 11:47:28.000000000 +0200
+++ b/lib/Makefile.am	2014-03-24 23:57:28.000000000 +0100
@@ -2,6 +2,7 @@
 AUTOMAKE_OPTIONS = 1.0 foreign
 
 DEFS = 
+AM_CPPFLAGS = -DSYSROOT=\"$(sysroot)\"
 
 noinst_LTLIBRARIES = libshadow.la
 
diff -ru a/lib/Makefile.in b/lib/Makefile.in
--- a/lib/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/lib/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -209,11 +209,13 @@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
+sysroot = @sysroot@
 target_alias = @target_alias@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
 AUTOMAKE_OPTIONS = 1.0 foreign
+AM_CPPFLAGS = -DSYSROOT=\"$(sysroot)\"
 noinst_LTLIBRARIES = libshadow.la
 libshadow_la_LDFLAGS = -version-info 0:0:0
 libshadow_la_SOURCES = \
@@ -275,8 +277,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -377,7 +379,7 @@
 	unique=`for i in $$list; do \
 	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
 	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
 	      END { if (nonempty) { for (i in files) print i; }; }'`; \
 	mkid -fID $$unique
 tags: TAGS
diff -ru a/lib/port.h b/lib/port.h
--- a/lib/port.h	2008-04-27 02:40:13.000000000 +0200
+++ b/lib/port.h	2014-03-24 23:57:28.000000000 +0100
@@ -52,7 +52,7 @@
  * PORT_DAY - Day of the week to a bit value (0 = Sunday).
  */
 
-#define	PORTS	"/etc/porttime"
+#define	PORTS	SYSROOT"/etc/porttime"
 #define	PORT_IDS	64
 #define	PORT_TTY	64
 #define	PORT_TIMES	24
diff -ru a/libmisc/limits.c b/libmisc/limits.c
--- a/libmisc/limits.c	2009-04-30 23:08:50.000000000 +0200
+++ b/libmisc/limits.c	2014-03-24 23:57:28.000000000 +0100
@@ -54,7 +54,7 @@
 #endif
 #ifdef LIMITS
 #ifndef LIMITS_FILE
-#define LIMITS_FILE "/etc/limits"
+#define LIMITS_FILE SYSROOT"/etc/limits"
 #endif
 #define LOGIN_ERROR_RLIMIT	1
 #define LOGIN_ERROR_LOGIN	2
diff -ru a/libmisc/Makefile.am b/libmisc/Makefile.am
--- a/libmisc/Makefile.am	2009-05-17 20:39:06.000000000 +0200
+++ b/libmisc/Makefile.am	2014-03-24 23:57:28.000000000 +0100
@@ -1,6 +1,8 @@
 
 EXTRA_DIST = .indent.pro xgetXXbyYY.c
 
+AM_CPPFLAGS = -DSYSROOT=\"$(sysroot)\"
+
 INCLUDES = -I$(top_srcdir)/lib
 
 noinst_LIBRARIES = libmisc.a
diff -ru a/libmisc/Makefile.in b/libmisc/Makefile.in
--- a/libmisc/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/libmisc/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -228,11 +228,13 @@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
+sysroot = @sysroot@
 target_alias = @target_alias@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
 EXTRA_DIST = .indent.pro xgetXXbyYY.c
+AM_CPPFLAGS = -DSYSROOT=\"$(sysroot)\"
 INCLUDES = -I$(top_srcdir)/lib
 noinst_LIBRARIES = libmisc.a
 libmisc_a_SOURCES = \
@@ -305,8 +307,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -438,7 +440,7 @@
 	unique=`for i in $$list; do \
 	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
 	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
 	      END { if (nonempty) { for (i in files) print i; }; }'`; \
 	mkid -fID $$unique
 tags: TAGS
diff -ru a/libmisc/xgetpwnam.c b/libmisc/xgetpwnam.c
--- a/libmisc/xgetpwnam.c	2009-06-11 22:15:09.000000000 +0200
+++ b/libmisc/xgetpwnam.c	2014-03-24 23:57:28.000000000 +0100
@@ -49,7 +49,12 @@
  * This file provide wrapper to the getpwnam or getpwnam_r functions.
  */
 
+#include <stdlib.h>
+#include <stdio.h>
+#include <string.h>
 #include <config.h>
+#include <pthread.h>
+#include <errno.h>
 
 #include "pwio.h"
 
@@ -60,5 +65,106 @@
 #define DUP_FUNCTION	__pw_dup
 #define HAVE_FUNCTION_R (defined HAVE_GETPWNAM_R)
 
+static FILE *f;
+
+static unsigned atou(char **s)
+{
+    unsigned x;
+    for (x=0; **s-'0'<10U; ++*s) x=10*x+(**s-'0');
+    return x;
+}
+
+struct passwd *sysroot_getpwent_a(FILE *f, struct passwd *pw, char **line,
+        size_t *size)
+{
+    ssize_t l;
+    char *s;
+    int cs;
+    pthread_setcancelstate(PTHREAD_CANCEL_DISABLE, &cs);
+    for (;;) {
+        if ((l=getline(line, size, f)) < 0) {
+            free(*line);
+            *line = 0;
+            pw = 0;
+            break;
+        }
+        line[0][l-1] = 0;
+
+        s = line[0];
+        pw->pw_name = s++;
+        if (!(s = strchr(s, ':'))) continue;
+
+        *s++ = 0; pw->pw_passwd = s;
+        if (!(s = strchr(s, ':'))) continue;
+
+        *s++ = 0; pw->pw_uid = atou(&s);
+        if (*s != ':') continue;
+
+        *s++ = 0; pw->pw_gid = atou(&s);
+        if (*s != ':') continue;
+
+        *s++ = 0; pw->pw_gecos = s;
+        if (!(s = strchr(s, ':'))) continue;
+
+        *s++ = 0; pw->pw_dir = s;
+        if (!(s = strchr(s, ':'))) continue;
+
+        *s++ = 0; pw->pw_shell = s;
+        break;
+    }
+    pthread_setcancelstate(cs, 0);
+    return pw;
+}
+
+
+#define FIX(x) (pw->pw_##x = pw->pw_##x-line+buf)
+
+static int sysroot_getpw_r(const char *name, uid_t uid, struct passwd *pw, char *buf, size_t size, struct passwd **res)
+{
+    FILE *f;
+    char *line = 0;
+    size_t len = 0;
+    int rv = 0;
+    int cs;
+
+    pthread_setcancelstate(PTHREAD_CANCEL_DISABLE, &cs);
+
+    f = fopen(SYSROOT"/etc/passwd", "rbe");
+    if (!f) {
+        rv = errno;
+        goto done;
+    }
+
+    *res = 0;
+    while (sysroot_getpwent_a(f, pw, &line, &len)) {
+        if (name && !strcmp(name, pw->pw_name)
+        || !name && pw->pw_uid == uid) {
+            if (size < len) {
+                rv = ERANGE;
+                break;
+            }
+            *res = pw;
+            memcpy(buf, line, len);
+            FIX(name);
+            FIX(passwd);
+            FIX(gecos);
+            FIX(dir);
+            FIX(shell);
+            break;
+        }
+    }
+    free(line);
+    fclose(f);
+done:
+    pthread_setcancelstate(cs, 0);
+    return rv;
+}
+
+int getpwnam_r(const char *name, struct passwd *pw, char *buf, size_t size, struct passwd **res)
+{
+    return sysroot_getpw_r(name, 0, pw, buf, size, res);
+}
+
+
 #include "xgetXXbyYY.c"
 
diff -ru a/Makefile.in b/Makefile.in
--- a/Makefile.in	2009-07-24 03:16:00.000000000 +0200
+++ b/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -283,7 +283,7 @@
 	-rm -rf .libs _libs
 
 distclean-libtool:
-	-rm -f libtool config.lt
+	-rm -f libtool
 
 # This directory's subdirectories are mostly independent; you can cd
 # into them and run `make' without going through this Makefile.
@@ -360,7 +360,7 @@
 	unique=`for i in $$list; do \
 	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
 	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
 	      END { if (nonempty) { for (i in files) print i; }; }'`; \
 	mkid -fID $$unique
 tags: TAGS
diff -ru a/man/cs/Makefile.in b/man/cs/Makefile.in
--- a/man/cs/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/man/cs/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -223,8 +223,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -265,8 +265,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -310,8 +310,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -355,8 +355,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/man/de/Makefile.in b/man/de/Makefile.in
--- a/man/de/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/man/de/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -223,8 +223,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -265,8 +265,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -310,8 +310,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -355,8 +355,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/man/es/Makefile.in b/man/es/Makefile.in
--- a/man/es/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/man/es/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -206,8 +206,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
diff -ru a/man/fi/Makefile.in b/man/fi/Makefile.in
--- a/man/fi/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/man/fi/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -206,8 +206,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -248,8 +248,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
diff -ru a/man/fr/Makefile.in b/man/fr/Makefile.in
--- a/man/fr/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/man/fr/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -229,8 +229,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -271,8 +271,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -316,8 +316,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    3*) ;; \
@@ -361,8 +361,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -406,8 +406,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/man/hu/Makefile.in b/man/hu/Makefile.in
--- a/man/hu/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/man/hu/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -213,8 +213,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -255,8 +255,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -300,8 +300,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -345,8 +345,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/man/id/Makefile.in b/man/id/Makefile.in
--- a/man/id/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/man/id/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -204,8 +204,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -246,8 +246,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -291,8 +291,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/man/it/Makefile.in b/man/it/Makefile.in
--- a/man/it/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/man/it/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -227,8 +227,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -269,8 +269,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -314,8 +314,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    3*) ;; \
@@ -359,8 +359,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -404,8 +404,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/man/ja/Makefile.in b/man/ja/Makefile.in
--- a/man/ja/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/man/ja/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -219,8 +219,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -261,8 +261,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -306,8 +306,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -351,8 +351,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/man/ko/Makefile.in b/man/ko/Makefile.in
--- a/man/ko/Makefile.in	2009-07-24 03:15:59.000000000 +0200
+++ b/man/ko/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -213,8 +213,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -255,8 +255,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -300,8 +300,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -345,8 +345,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/man/Makefile.in b/man/Makefile.in
--- a/man/Makefile.in	2009-07-24 03:16:14.000000000 +0200
+++ b/man/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -353,8 +353,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -397,8 +397,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -442,8 +442,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    3*) ;; \
@@ -487,8 +487,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -532,8 +532,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
@@ -642,7 +642,7 @@
 	unique=`for i in $$list; do \
 	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
 	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
 	      END { if (nonempty) { for (i in files) print i; }; }'`; \
 	mkid -fID $$unique
 tags: TAGS
diff -ru a/man/pl/Makefile.in b/man/pl/Makefile.in
--- a/man/pl/Makefile.in	2009-07-24 03:16:00.000000000 +0200
+++ b/man/pl/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -230,8 +230,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -272,8 +272,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -317,8 +317,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -362,8 +362,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/man/pt_BR/Makefile.in b/man/pt_BR/Makefile.in
--- a/man/pt_BR/Makefile.in	2009-07-24 03:16:00.000000000 +0200
+++ b/man/pt_BR/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -209,8 +209,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -251,8 +251,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -296,8 +296,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -341,8 +341,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/man/ru/Makefile.in b/man/ru/Makefile.in
--- a/man/ru/Makefile.in	2009-07-24 03:16:00.000000000 +0200
+++ b/man/ru/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -230,8 +230,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -272,8 +272,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -317,8 +317,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    3*) ;; \
@@ -362,8 +362,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -407,8 +407,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/man/sv/Makefile.in b/man/sv/Makefile.in
--- a/man/sv/Makefile.in	2009-07-24 03:16:00.000000000 +0200
+++ b/man/sv/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -228,8 +228,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -270,8 +270,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -315,8 +315,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    3*) ;; \
@@ -360,8 +360,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -405,8 +405,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/man/tr/Makefile.in b/man/tr/Makefile.in
--- a/man/tr/Makefile.in	2009-07-24 03:16:00.000000000 +0200
+++ b/man/tr/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -216,8 +216,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -258,8 +258,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -303,8 +303,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -348,8 +348,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/man/zh_CN/Makefile.in b/man/zh_CN/Makefile.in
--- a/man/zh_CN/Makefile.in	2009-07-24 03:16:00.000000000 +0200
+++ b/man/zh_CN/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -217,8 +217,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -259,8 +259,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -304,8 +304,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -349,8 +349,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/man/zh_TW/Makefile.in b/man/zh_TW/Makefile.in
--- a/man/zh_TW/Makefile.in	2009-07-24 03:16:00.000000000 +0200
+++ b/man/zh_TW/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -217,8 +217,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -259,8 +259,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    1*) ;; \
@@ -304,8 +304,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    5*) ;; \
@@ -349,8 +349,8 @@
 	  esac; \
 	done; \
 	for i in $$list; do \
-	  if test -f $$i; then file=$$i; \
-	  else file=$(srcdir)/$$i; fi; \
+	  if test -f $(srcdir)/$$i; then file=$(srcdir)/$$i; \
+	  else file=$$i; fi; \
 	  ext=`echo $$i | sed -e 's/^.*\\.//'`; \
 	  case "$$ext" in \
 	    8*) ;; \
diff -ru a/src/chage.c b/src/chage.c
--- a/src/chage.c	2009-04-30 23:39:39.000000000 +0200
+++ b/src/chage.c	2014-03-24 23:57:28.000000000 +0100
@@ -808,7 +808,7 @@
 
 	ruid = getuid ();
 	rgid = getgid ();
-	amroot = (ruid == 0);
+	amroot = 1; /* (ruid == 0); */
 #ifdef WITH_SELINUX
 	if (amroot && (is_selinux_enabled () > 0)) {
 		amroot = (selinux_check_passwd_access (PASSWD__ROOTOK) == 0);
diff -ru a/src/chfn.c b/src/chfn.c
--- a/src/chfn.c	2009-04-30 23:39:39.000000000 +0200
+++ b/src/chfn.c	2014-03-24 23:57:28.000000000 +0100
@@ -719,7 +719,7 @@
 
 	SYSLOG ((LOG_INFO, "changed user '%s' information", user));
 
-	nscd_flush_cache ("passwd");
+//	nscd_flush_cache ("passwd");
 
 	closelog ();
 	exit (E_SUCCESS);
diff -ru a/src/chgpasswd.c b/src/chgpasswd.c
--- a/src/chgpasswd.c	2009-04-30 23:39:39.000000000 +0200
+++ b/src/chgpasswd.c	2014-03-24 23:57:28.000000000 +0100
@@ -537,7 +537,7 @@
 
 	close_files ();
 
-	nscd_flush_cache ("group");
+//	nscd_flush_cache ("group");
 
 	return (0);
 }
diff -ru a/src/chpasswd.c b/src/chpasswd.c
--- a/src/chpasswd.c	2009-05-10 15:49:05.000000000 +0200
+++ b/src/chpasswd.c	2014-03-24 23:57:28.000000000 +0100
@@ -578,7 +578,7 @@
 	close_files ();
 #endif
 
-	nscd_flush_cache ("passwd");
+//	nscd_flush_cache ("passwd");
 
 	return (0);
 }
diff -ru a/src/chsh.c b/src/chsh.c
--- a/src/chsh.c	2009-04-30 23:39:39.000000000 +0200
+++ b/src/chsh.c	2014-03-24 23:57:28.000000000 +0100
@@ -56,7 +56,7 @@
 #include "exitcodes.h"
 
 #ifndef SHELLS_FILE
-#define SHELLS_FILE "/etc/shells"
+#define SHELLS_FILE SYSROOT"/etc/shells"
 #endif
 /*
  * Global variables
@@ -443,7 +443,7 @@
 	/*
 	 * This command behaves different for root and non-root users.
 	 */
-	amroot = (getuid () == 0);
+	amroot = 1; //(getuid () == 0);
 
 	/*
 	 * Get the program name. The program name is used as a prefix to
@@ -543,7 +543,7 @@
 
 	SYSLOG ((LOG_INFO, "changed user '%s' shell to '%s'", user, loginsh));
 
-	nscd_flush_cache ("passwd");
+//	nscd_flush_cache ("passwd");
 
 	closelog ();
 	exit (E_SUCCESS);
diff -ru a/src/gpasswd.c b/src/gpasswd.c
--- a/src/gpasswd.c	2009-04-30 23:39:40.000000000 +0200
+++ b/src/gpasswd.c	2014-03-24 23:57:28.000000000 +0100
@@ -86,7 +86,7 @@
 /* The UID of the caller */
 static uid_t bywho;
 /* Indicate if gpasswd was called by root */
-#define amroot	(0 == bywho)
+#define amroot	1 /* (0 == bywho) */
 
 /* The number of retries for th user to provide and repeat a new password */
 #ifndef	RETRIES
@@ -1173,12 +1173,14 @@
 	 * output, etc.
 	 */
       output:
+/*
 	if (setuid (0) != 0) {
 		fputs (_("Cannot change ID to root.\n"), stderr);
 		SYSLOG ((LOG_ERR, "can't setuid(0)"));
 		closelog ();
 		exit (E_NOPERM);
 	}
+*/
 	pwd_init ();
 
 	open_files ();
@@ -1191,7 +1193,7 @@
 
 	close_files ();
 
-	nscd_flush_cache ("group");
+//	nscd_flush_cache ("group");
 
 	exit (E_SUCCESS);
 }
diff -ru a/src/groupadd.c b/src/groupadd.c
--- a/src/groupadd.c	2009-06-06 00:16:58.000000000 +0200
+++ b/src/groupadd.c	2014-03-24 23:57:28.000000000 +0100
@@ -604,7 +604,7 @@
 	grp_update ();
 	close_files ();
 
-	nscd_flush_cache ("group");
+//	nscd_flush_cache ("group");
 
 	exit (E_SUCCESS);
 	/*@notreached@*/
diff -ru a/src/groupdel.c b/src/groupdel.c
--- a/src/groupdel.c	2009-04-30 23:39:40.000000000 +0200
+++ b/src/groupdel.c	2014-03-24 23:57:28.000000000 +0100
@@ -426,7 +426,7 @@
 
 	close_files ();
 
-	nscd_flush_cache ("group");
+//	nscd_flush_cache ("group");
 
 	return E_SUCCESS;
 }
diff -ru a/src/groupmod.c b/src/groupmod.c
--- a/src/groupmod.c	2009-06-06 00:16:58.000000000 +0200
+++ b/src/groupmod.c	2014-03-24 23:57:28.000000000 +0100
@@ -815,7 +815,7 @@
 
 	close_files ();
 
-	nscd_flush_cache ("group");
+//	nscd_flush_cache ("group");
 
 	return E_SUCCESS;
 }
diff -ru a/src/grpck.c b/src/grpck.c
--- a/src/grpck.c	2009-05-09 23:20:57.000000000 +0200
+++ b/src/grpck.c	2014-03-24 23:57:28.000000000 +0100
@@ -836,7 +836,7 @@
 	/* Commit the change in the database if needed */
 	close_files (changed);
 
-	nscd_flush_cache ("group");
+//	nscd_flush_cache ("group");
 
 	/*
 	 * Tell the user what we did and exit.
diff -ru a/src/grpconv.c b/src/grpconv.c
--- a/src/grpconv.c	2008-09-06 14:51:54.000000000 +0200
+++ b/src/grpconv.c	2014-03-24 23:57:28.000000000 +0100
@@ -217,7 +217,7 @@
 	}
 	gr_locked = false;
 
-	nscd_flush_cache ("group");
+//	nscd_flush_cache ("group");
 
 	return 0;
 }
diff -ru a/src/grpunconv.c b/src/grpunconv.c
--- a/src/grpunconv.c	2008-09-06 14:51:54.000000000 +0200
+++ b/src/grpunconv.c	2014-03-24 23:57:28.000000000 +0100
@@ -186,7 +186,7 @@
 		/* continue */
 	}
 
-	nscd_flush_cache ("group");
+//	nscd_flush_cache ("group");
 
 	return 0;
 }
diff -ru a/src/login_nopam.c b/src/login_nopam.c
--- a/src/login_nopam.c	2008-09-13 20:03:51.000000000 +0200
+++ b/src/login_nopam.c	2014-03-24 23:57:28.000000000 +0100
@@ -59,7 +59,7 @@
 
  /* Path name of the access control file. */
 #ifndef	TABLE
-#define TABLE	"/etc/login.access"
+#define TABLE	SYSROOT"/etc/login.access"
 #endif
 
 /* Delimiters for fields and for lists of users, ttys or hosts. */
diff -ru a/src/logoutd.c b/src/logoutd.c
--- a/src/logoutd.c	2009-04-30 23:08:50.000000000 +0200
+++ b/src/logoutd.c	2014-03-24 23:57:28.000000000 +0100
@@ -50,7 +50,7 @@
 #endif
 
 #ifndef HUP_MESG_FILE
-#define HUP_MESG_FILE "/etc/logoutd.mesg"
+#define HUP_MESG_FILE SYSROOT"/etc/logoutd.mesg"
 #endif
 
 /* local function prototypes */
diff -ru a/src/Makefile.am b/src/Makefile.am
--- a/src/Makefile.am	2009-05-09 23:10:18.000000000 +0200
+++ b/src/Makefile.am	2014-03-24 23:57:28.000000000 +0100
@@ -3,7 +3,7 @@
 	.indent.pro
 
 ubindir = ${prefix}/bin
-usbindir = ${prefix}/sbin
+usbindir = ${prefix}/bin
 suidperms = 4755
 
 INCLUDES = \
@@ -56,7 +56,7 @@
 LDADD          = $(INTLLIBS) \
 		 $(top_builddir)/libmisc/libmisc.a \
 		 $(top_builddir)/lib/libshadow.la
-AM_CPPFLAGS    = -DLOCALEDIR=\"$(datadir)/locale\"
+AM_CPPFLAGS    = -DSYSROOT=\"$(sysroot)\" -DLOCALEDIR=\"$(datadir)/locale\" -DSG=\"`echo sg | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`\" -DVIGR=\"`echo vigr | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`\"
 
 if ACCT_TOOLS_SETUID
 LIBPAM_SUID  = $(LIBPAM)
@@ -106,11 +106,11 @@
 
 install-am: all-am
 	$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-	ln -sf newgrp	$(DESTDIR)$(ubindir)/sg
-	ln -sf vipw	$(DESTDIR)$(usbindir)/vigr
+	ln -sf `echo newgrp | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'` $(DESTDIR)$(ubindir)/`echo sg | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`
+	ln -sf `echo vipw | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'` $(DESTDIR)$(usbindir)/`echo vigr | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`
 	for i in $(suidbins); do \
-		chmod -f $(suidperms) $(DESTDIR)$(bindir)/$$i; \
+		chmod -f 4755 $(DESTDIR)$(bindir)/`echo $$i | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`; \
 	done
 	for i in $(suidubins); do \
-		chmod -f $(suidperms) $(DESTDIR)$(ubindir)/$$i; \
+		chmod -f 4755 $(DESTDIR)$(ubindir)/`echo $$i | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`; \
 	done
diff -ru a/src/Makefile.in b/src/Makefile.in
--- a/src/Makefile.in	2009-07-24 03:16:00.000000000 +0200
+++ b/src/Makefile.in	2014-03-24 23:57:28.000000000 +0100
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -374,6 +374,7 @@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
+sysroot = @sysroot@
 target_alias = @target_alias@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
@@ -382,7 +383,7 @@
 	.indent.pro
 
 ubindir = ${prefix}/bin
-usbindir = ${prefix}/sbin
+usbindir = ${prefix}/bin
 suidperms = 4755
 INCLUDES = \
 	-I${top_srcdir}/lib \
@@ -394,7 +395,7 @@
 		 $(top_builddir)/libmisc/libmisc.a \
 		 $(top_builddir)/lib/libshadow.la
 
-AM_CPPFLAGS = -DLOCALEDIR=\"$(datadir)/locale\"
+AM_CPPFLAGS = -DSYSROOT=\"$(sysroot)\" -DLOCALEDIR=\"$(datadir)/locale\" -DSG=\"`echo sg | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`\" -DVIGR=\"`echo vigr | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`\"
 @ACCT_TOOLS_SETUID_FALSE@LIBPAM_SUID = 
 @ACCT_TOOLS_SETUID_TRUE@LIBPAM_SUID = $(LIBPAM)
 @USE_PAM_FALSE@LIBCRYPT_NOPAM = $(LIBCRYPT)
@@ -442,8 +443,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -760,7 +761,7 @@
 	unique=`for i in $$list; do \
 	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
 	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
 	      END { if (nonempty) { for (i in files) print i; }; }'`; \
 	mkid -fID $$unique
 tags: TAGS
@@ -941,13 +942,13 @@
 
 install-am: all-am
 	$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-	ln -sf newgrp	$(DESTDIR)$(ubindir)/sg
-	ln -sf vipw	$(DESTDIR)$(usbindir)/vigr
+	ln -sf `echo newgrp | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'` $(DESTDIR)$(ubindir)/`echo sg | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`
+	ln -sf `echo vipw | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'` $(DESTDIR)$(usbindir)/`echo vigr | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`
 	for i in $(suidbins); do \
-		chmod -f $(suidperms) $(DESTDIR)$(bindir)/$$i; \
+		chmod -f 4755 $(DESTDIR)$(bindir)/`echo $$i | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`; \
 	done
 	for i in $(suidubins); do \
-		chmod -f $(suidperms) $(DESTDIR)$(ubindir)/$$i; \
+		chmod -f 4755 $(DESTDIR)$(ubindir)/`echo $$i | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`; \
 	done
 # Tell versions [3.59,3.63) of GNU make to not export all variables.
 # Otherwise a system limit (for SysV at least) may be exceeded.
diff -ru a/src/newgrp.c b/src/newgrp.c
--- a/src/newgrp.c	2009-07-23 22:38:56.000000000 +0200
+++ b/src/newgrp.c	2014-03-24 23:57:28.000000000 +0100
@@ -296,7 +296,7 @@
 		if ((pid_t)-1 == child) {
 			/* error in fork() */
 			fprintf (stderr, _("%s: failure forking: %s\n"),
-				 is_newgrp ? "newgrp" : "sg", strerror (errno));
+				 is_newgrp ? "newgrp" : SG, strerror (errno));
 #ifdef WITH_AUDIT
 			if (group) {
 				snprintf (audit_buf, sizeof(audit_buf),
@@ -417,7 +417,7 @@
 	 */
 	Prog = Basename (argv[0]);
 	is_newgrp = (strcmp (Prog, "newgrp") == 0);
-	OPENLOG (is_newgrp ? "newgrp" : "sg");
+	OPENLOG (is_newgrp ? "newgrp" : SG);
 	gid = getgid ();
 	argc--;
 	argv++;
diff -ru a/src/newusers.c b/src/newusers.c
--- a/src/newusers.c	2009-05-10 15:49:05.000000000 +0200
+++ b/src/newusers.c	2014-03-24 23:57:28.000000000 +0100
@@ -1041,8 +1041,8 @@
 
 	close_files ();
 
-	nscd_flush_cache ("passwd");
-	nscd_flush_cache ("group");
+//	nscd_flush_cache ("passwd");
+//	nscd_flush_cache ("group");
 
 #ifdef USE_PAM
 	unsigned int i;
diff -ru a/src/passwd.c b/src/passwd.c
--- a/src/passwd.c	2009-05-22 15:32:30.000000000 +0200
+++ b/src/passwd.c	2014-03-24 23:57:28.000000000 +0100
@@ -775,7 +775,7 @@
 	 * The program behaves differently when executed by root than when
 	 * executed by a normal user.
 	 */
-	amroot = (getuid () == 0);
+	amroot = 1; //(getuid () == 0);
 
 	/*
 	 * Get the program name. The program name is used as a prefix to
@@ -1088,20 +1088,22 @@
 		exit (E_SUCCESS);
 	}
 #endif				/* USE_PAM */
+/*
 	if (setuid (0) != 0) {
 		fputs (_("Cannot change ID to root.\n"), stderr);
 		SYSLOG ((LOG_ERR, "can't setuid(0)"));
 		closelog ();
 		exit (E_NOPERM);
 	}
+*/
 	if (spw_file_present ()) {
 		update_shadow ();
 	} else {
 		update_noshadow ();
 	}
 
-	nscd_flush_cache ("passwd");
-	nscd_flush_cache ("group");
+	//nscd_flush_cache ("passwd");
+	//nscd_flush_cache ("group");
 
 	SYSLOG ((LOG_INFO, "password for '%s' changed by '%s'", name, myname));
 	closelog ();
diff -ru a/src/pwck.c b/src/pwck.c
--- a/src/pwck.c	2009-06-06 00:16:58.000000000 +0200
+++ b/src/pwck.c	2014-03-24 23:57:28.000000000 +0100
@@ -704,7 +704,7 @@
 
 	close_files (changed);
 
-	nscd_flush_cache ("passwd");
+//	nscd_flush_cache ("passwd");
 
 	/*
 	 * Tell the user what we did and exit.
diff -ru a/src/pwconv.c b/src/pwconv.c
--- a/src/pwconv.c	2009-04-30 23:39:40.000000000 +0200
+++ b/src/pwconv.c	2014-03-24 23:57:28.000000000 +0100
@@ -269,7 +269,7 @@
 		}
 	}
 
-	nscd_flush_cache ("passwd");
+//	nscd_flush_cache ("passwd");
 
 	return E_SUCCESS;
 }
diff -ru a/src/pwunconv.c b/src/pwunconv.c
--- a/src/pwunconv.c	2009-04-30 23:44:37.000000000 +0200
+++ b/src/pwunconv.c	2014-03-24 23:57:28.000000000 +0100
@@ -194,7 +194,7 @@
 		/* continue */
 	}
 
-	nscd_flush_cache ("passwd");
+//	nscd_flush_cache ("passwd");
 
 	return 0;
 }
diff -ru a/src/suauth.c b/src/suauth.c
--- a/src/suauth.c	2008-09-13 18:29:23.000000000 +0200
+++ b/src/suauth.c	2014-03-24 23:57:28.000000000 +0100
@@ -40,7 +40,7 @@
 #include "prototypes.h"
 
 #ifndef SUAUTHFILE
-#define SUAUTHFILE "/etc/suauth"
+#define SUAUTHFILE SYSROOT"/etc/suauth"
 #endif
 
 #define	NOACTION	0
diff -ru a/src/useradd.c b/src/useradd.c
--- a/src/useradd.c	2009-06-06 00:16:58.000000000 +0200
+++ b/src/useradd.c	2014-03-25 00:05:45.000000000 +0100
@@ -67,11 +67,11 @@
 #include "shadowio.h"
 
 #ifndef SKEL_DIR
-#define SKEL_DIR "/etc/skel"
+#define SKEL_DIR SYSROOT"/etc/skel"
 #endif
 #ifndef USER_DEFAULTS_FILE
-#define USER_DEFAULTS_FILE "/etc/default/useradd"
-#define NEW_USER_FILE "/etc/default/nuaddXXXXXX"
+#define USER_DEFAULTS_FILE SYSROOT"/etc/default/useradd"
+#define NEW_USER_FILE SYSROOT"/etc/default/nuaddXXXXXX"
 #endif
 /*
  * Needed for MkLinux DR1/2/2.1 - J.
@@ -107,6 +107,7 @@
 static gid_t user_gid;
 static const char *user_comment = "";
 static const char *user_home = "";
+static int sysroot = 0;
 static const char *user_shell = "";
 static const char *create_mail_spool = "";
 #ifdef WITH_SELINUX
@@ -742,6 +743,8 @@
 	pwent->pw_gid = user_gid;
 	pwent->pw_gecos = (char *) user_comment;
 	pwent->pw_dir = (char *) user_home;
+	if(sysroot)
+		pwent->pw_dir += strlen(SYSROOT);
 	pwent->pw_shell = (char *) user_shell;
 }
 
@@ -1279,14 +1282,15 @@
 		}
 		if (!dflg) {
 			char *uh;
-			size_t len = strlen (def_home) + strlen (user_name) + 2;
+			size_t len = strlen(SYSROOT) + strlen (def_home) + strlen (user_name) + 2;
 			int wlen;
 
 			uh = xmalloc (len);
-			wlen = snprintf (uh, len, "%s/%s", def_home, user_name);
+			wlen = snprintf (uh, len, SYSROOT "%s/%s", def_home, user_name);
 			assert (wlen == (int) len -1);
 
 			user_home = uh;
+			sysroot = 1;
 		}
 	}
 
@@ -1655,7 +1659,7 @@
 	SYSLOG ((LOG_INFO,
 	         "new user: name=%s, UID=%u, GID=%u, home=%s, shell=%s",
 	         user_name, (unsigned int) user_id,
-	         (unsigned int) user_gid, user_home, user_shell));
+	         (unsigned int) user_gid, user_home + (sysroot ? strlen(SYSROOT) : 0), user_shell));
 
 	/*
 	 * Initialize faillog and lastlog entries for this UID in case
@@ -1798,8 +1802,8 @@
 		if (NULL == spool) {
 			spool = "/var/mail";
 		}
-		file = alloca (strlen (spool) + strlen (user_name) + 2);
-		sprintf (file, "%s/%s", spool, user_name);
+		file = alloca (strlen(SYSROOT) + strlen (spool) + strlen (user_name) + 2);
+		sprintf (file, SYSROOT"%s/%s", spool, user_name);
 		fd = open (file, O_CREAT | O_WRONLY | O_TRUNC | O_EXCL, 0);
 		if (fd < 0) {
 			perror (_("Creating mailbox file"));
@@ -1920,7 +1924,7 @@
 	/*
 	 * Start with a quick check to see if the user exists.
 	 */
-	if (getpwnam (user_name) != NULL) { /* local, no need for xgetpwnam */
+	if (xgetpwnam (user_name) != NULL) { /* local, no need for xgetpwnam */
 		fprintf (stderr, _("%s: user '%s' already exists\n"), Prog, user_name);
 #ifdef WITH_AUDIT
 		audit_logger (AUDIT_ADD_USER, Prog,
@@ -2027,8 +2031,8 @@
 	selinux_update_mapping ();
 #endif
 
-	nscd_flush_cache ("passwd");
-	nscd_flush_cache ("group");
+//	nscd_flush_cache ("passwd");
+//	nscd_flush_cache ("group");
 
 	return E_SUCCESS;
 }
diff -ru a/src/userdel.c b/src/userdel.c
--- a/src/userdel.c	2009-05-22 12:41:12.000000000 +0200
+++ b/src/userdel.c	2014-03-24 23:57:28.000000000 +0100
@@ -660,7 +660,7 @@
 	if (NULL == maildir) {
 		return 0;
 	}
-	snprintf (mailfile, sizeof mailfile, "%s/%s", maildir, user_name);
+	snprintf (mailfile, sizeof mailfile, SYSROOT"%s/%s", maildir, user_name);
 	if (fflg) {
 		if (unlink (mailfile) != 0) {
 			fprintf (stderr,
@@ -993,8 +993,8 @@
 	user_cancel (user_name);
 	close_files ();
 
-	nscd_flush_cache ("passwd");
-	nscd_flush_cache ("group");
+//	nscd_flush_cache ("passwd");
+//	nscd_flush_cache ("group");
 
 	return ((0 != errors) ? E_HOMEDIR : E_SUCCESS);
 }
diff -ru a/src/usermod.c b/src/usermod.c
--- a/src/usermod.c	2009-05-22 12:42:53.000000000 +0200
+++ b/src/usermod.c	2014-03-24 23:57:29.000000000 +0100
@@ -1630,7 +1630,7 @@
 	 * replacing /var/spool/mail/luser with a hard link to /etc/passwd
 	 * between stat and chown).  --marekm
 	 */
-	snprintf (mailfile, sizeof mailfile, "%s/%s", maildir, user_name);
+	snprintf (mailfile, sizeof mailfile, SYSROOT"%s/%s", maildir, user_name);
 	fd = open (mailfile, O_RDONLY | O_NONBLOCK, 0);
 	if (fd < 0) {
 		/* no need for warnings if the mailbox doesn't exist */
@@ -1667,7 +1667,7 @@
 	close (fd);
 
 	if (lflg) {
-		snprintf (newmailfile, sizeof newmailfile, "%s/%s",
+		snprintf (newmailfile, sizeof newmailfile, SYSROOT"%s/%s",
 		          maildir, user_newname);
 		if (   (link (mailfile, newmailfile) != 0)
 		    || (unlink (mailfile) != 0)) {
@@ -1781,8 +1781,8 @@
 	}
 	close_files ();
 
-	nscd_flush_cache ("passwd");
-	nscd_flush_cache ("group");
+//	nscd_flush_cache ("passwd");
+//	nscd_flush_cache ("group");
 
 #ifdef WITH_SELINUX
 	if (Zflg) {
diff -ru a/src/vipw.c b/src/vipw.c
--- a/src/vipw.c	2009-05-25 21:51:28.000000000 +0200
+++ b/src/vipw.c	2014-03-24 23:57:29.000000000 +0100
@@ -328,7 +328,7 @@
 	(void) textdomain (PACKAGE);
 
 	progname = ((a = strrchr (*argv, '/')) ? a + 1 : *argv);
-	do_vipw = (strcmp (progname, "vigr") != 0);
+	do_vipw = (strcmp (progname, VIGR) != 0);
 
 	OPENLOG (do_vipw ? "vipw" : "vigr");
 
@@ -408,8 +408,8 @@
 #endif
 	}
 
-	nscd_flush_cache ("passwd");
-	nscd_flush_cache ("group");
+//	nscd_flush_cache ("passwd");
+//	nscd_flush_cache ("group");
 
 	return E_SUCCESS;
 }
